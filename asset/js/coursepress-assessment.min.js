/*! CoursePress - v2.2.2
 * https://premium.wpmudev.org/project/coursepress-pro/
 * Copyright (c) 2019; * Licensed GPLv2+ */
+function(a){CoursePress=CoursePress||{},CoursePress.Events=CoursePress.Events||_.extend({},Backbone.Events),CoursePress.Models.Units=CoursePress.Models.Post.extend({url:_coursepress._ajax_url+"?action=coursepress_assessments",parse:function(a){var b=this.get("action");1==a.success?this.trigger("coursepress:"+b+"_success",a.data):this.trigger("coursepress:"+b+"_error",a.data),this.set("action","")}}),CoursePress.UnitsPost=new CoursePress.Models.Units;var b=1,c="all",d=function(b,d){var e=a(".cp-unit-div").filter(function(){var c=a(this).data();return c.unit==b&&c.student==d}),f=a(".module-grade",e),g=a(".module-assessable .module-grade",e),h=0,i=a('.cp-total-unit-modules[data-unit="'+b+'"]').first().val();return"all"!=c&&(f=g),_.each(f,function(b){b=a(b);var c=b.val();c=c&&null!=c?parseInt(c):0,h+=c}),h=h>0&&i>0?Math.ceil(h/i):0},e=function(b,c){var d=a('.final-grade[data-student="'+b+'"], [data-student="'+b+'"] .final-grade');c&&d.html(c+"%")},f=function(){var b=a(this),c=b.siblings("button"),d=!b.is(".edit-no-feedback"),e=b.parents(".cp-grade-editor").first(),f=a(".module-grade",e),g=a(".cp-feedback-editor",e).hide(),i="cp_editor_"+f.data("module")+"_"+f.data("student"),j=a(".cp-grade-editor-box",e),k=(e.parents(".cp-unit-div").first(),a(".cp-edit-grade-box",e)),l=a(".cp-save-as-draft",e);b.is(".disabled")||(j.slideDown(),c.addClass("disabled"),d?(g.show(),h(i,g,e),k.appendTo(g),l.show()):(k.prependTo(j),l.hide()))},g=function(){var b=a(this),c=b.parents(".cp-grade-editor"),f=b.parents(".cp-module"),g=a(".cp-cancel",c),h=a(".cp-save-as-draft",f),i=a(".module-grade",c),j=a(".cp_feedback_content",c),k=!!a(".edit-no-feedback").is(".disabled"),l=a(".cp-check",c),m=a(".cp-current-grade",c),n=parseInt(i.data("minimum")),o=parseInt(i.val()),p=o>=n,q=a(".cp-module-grade-info",c),r=a(".edit-with-feedback",c),s=a(".edit-no-feedback",c),t=i.data("unit"),u=i.data("module"),v=i.data("student"),w=c.parents(".cp-unit-div").first(),x=a(".unit-data .unit-grade",w);if(!b.is(".disabled")){var y=CoursePress.ProgressIndicator(),z={course_id:i.data("courseid"),unit_id:t,module_id:u,student_id:v,with_feedback:k,feedback_content:j.val(),student_grade:o,action:"update"};y.icon.insertAfter(this),CoursePress.UnitsPost.save(z),CoursePress.UnitsPost.off("coursepress:update_success"),CoursePress.UnitsPost.on("coursepress:update_success",function(b){CoursePress.Events.on("coursepress:progress:success",function(){i.attr("data-grade",o).data("grade",o),h.addClass("disabled"),g.trigger("click"),m.html(o+"%"),q.show(),p?l.removeClass("red").addClass("green").html(_coursepress.assessment_labels.pass):l.removeClass("green").addClass("red").html(_coursepress.assessment_labels.fail),r.html(_coursepress.assessment_labels.edit_with_feedback),s.html(_coursepress.assessment_labels.edit_no_feedback);d(t,v),e(v,b.course_grade);if(x.html(b.unit_grade+"%"),k&&""!=z.feedback_content.trim()){var c=a(".cp-instructor-feedback",f).show();a(".cp-draft-icon",c)[k?"hide":"show"](),a(".description",c).hide(),a(".cp-feedback-details",c).html(z.feedback_content),a("cite",c).html("- "+_coursepress.instructor_name)}a('[data-student="'+v+'"] .cp-certified')[!0===b.completed?"show":"hide"]()}),y.success()}),CoursePress.UnitsPost.on("coursepress:update_error",function(){y.error(_coursepress.server_error)})}},h=function(b,c,d){var e=a(".cp_feedback_content",d),f=e.val(),g=a(".wp-editor-container",c).length>0,h=a(".cp-submit-grade",d),i=a(".cp-save-as-draft",d);g||(CoursePress.Events.off("editor:keyup"),CoursePress.Events.on("editor:keyup",function(c){var d=void 0!=typeof c.getContent&&c.getContent?c.getContent():a("#"+b).val();d!=f&&(e.val(d),h.removeClass("disabled"),i.removeClass("disabled"))}),CoursePress.editor.create(c,b,b,f))},i=function(){var b=a(this),c=b.siblings(".cp-submit-grade"),d=parseFloat(b.val());d>100&&(d=100),0>d&&(d=0),b.val(d),c[d>=0?"removeClass":"addClass"]("disabled")},j=function(){var b=a(this),c=b.parents(".cp-grade-editor").first(),d=a(".cp-grade-editor-box",c),e=a(".cp-assessment-div button"),f=a(".module-grade",c),g=a(".cp-submit-grade",c);f.val(f.data("grade")),g.addClass("disabled"),d.slideUp(),e.removeClass("disabled")},k=function(){var b=a(this),c=b.parents(".cp-grade-editor"),d=b.parents(".cp-module"),e=a(".cp_feedback_content",c),f=a(".cp-cancel",c),g=a(".module-grade",c),h=g.data("courseid"),i=g.data("unit"),j=g.data("module"),k=g.data("student");if(!b.is(".disabled")){var l=CoursePress.ProgressIndicator();l.icon.addClass("cp-right").insertAfter(this);var m={course_id:h,unit_id:i,module_id:j,student_id:k,feedback_content:e.val(),action:"save_draft_feedback"};CoursePress.UnitsPost.save(m),CoursePress.UnitsPost.off("coursepress:save_draft_feedback_success"),CoursePress.UnitsPost.on("coursepress:save_draft_feedback_success",function(){CoursePress.Events.on("coursepress:progress:success",function(){b.addClass("disabled");var c=a(".cp-instructor-feedback",d).show();a(".cp-draft-icon",c).show();a(".description",c).hide(),a(".cp-feedback-details",c).html(m.feedback_content),a("cite",c).html("- "+_coursepress.instructor_name),f.trigger("click")}),l.success(_coursepress.assessment_labels.sucess)}),CoursePress.UnitsPost.off("coursepress:save_draft_feedback_error"),CoursePress.UnitsPost.on("coursepress:save_draft_feedback_error",function(){l.error(_coursepress.server_error)})}},l=function(){a(".cp-content script").each(function(){var b=a(this);template=b.html(),b.replaceWith(template)});var b=a(".cp-unit-div"),c=(a(".cp-table"),a(".student-row")),d=a("#unit-list").val();_.each(c,function(b){b=a(b);var c=b.data("student");e(c)}),_.each(b,function(b){b=a(b);var c=b.data("unit"),e=b.data("student"),f=a(".cp-toggle",b);m(c,e),f[d>0?"hide":"show"]()}),a(".cp-edit-grade-box").attr("data-title",_coursepress.assessment_labels.help_tooltip)},m=function(b,c){var e=(d(b,c),a(".cp-unit-div .unit-grade"));a('<span class="cp-check green">').html(_coursepress.assessment_labels.pass),a('<span class="cp-check red">').html(_coursepress.assessment_labels.fail);_.each(e,function(c){c=a(c);var d=c.data();d.unit==b&&d.student})},n=function(){var c=a("#assessment-table-container"),d=a("#unit-list").val(),e=a("#ungraded-list").val(),f=a("#course-list").val(),g=a("#assessment-orderby").val(),h=a("#assessment-order").val(),i=a(".cp-loader-info"),j=a("#search_student_box"),k=j.siblings("#search_reset");if(f){""!=j.val()?k.removeClass("disabled"):k.addClass("disabled");var m={course_id:f,unit_id:d,student_type:e,paged:b,action:"table",search:j.val(),orderby:g,order:h};c.empty(),i.show(),q(),CoursePress.UnitsPost.save(m),CoursePress.UnitsPost.on("coursepress:table_success",function(a){c.html(a.html),i.hide(),l()})}},o=function(){var b=a(this),c=a("#search_student_box",b),d=a("#search_student_submit",b),e=d.siblings("#search_reset");return!!c.val()&&(e.removeClass("disabled"),n(),!1)},p=function(){var b=a(this);a("#search_student_box").val(""),n(),b.addClass("disabled")},q=function(){var c=a("#unit-list"),d=a("#ungraded-list"),e=a("#base_location").val();e+="&unit="+c.val()+"&type="+d.val(),b>1&&(e+="&paged="+b),history.pushState({},null,e)},r=function(){var c=a(this),d=(c.attr("href","#"),c.data("paged"));return b=d,n(),!1},s=function(){var b=a(this).val(),c=window.location.toString();c+="&display="+b,window.location=c},t=function(){var b=a(this),c=b.find(".dashicons"),d=b.siblings(),e=d.is(":visible");d[e?"slideUp":"slideDown"](),c[e?"removeClass":"addClass"]("dashicons-arrow-down"),c[e?"addClass":"removeClass"]("dashicons-arrow-up")},u=function(){var b=a(this),c=b.data(),d=a("#student-grade-"+c.student),e=!1,f=wp.template("assessment-modules");if(0==d.length){var g={course_id:parseInt(a("#course-list").val()),student_id:c.student,action:"get_student_modules"};CoursePress.UnitsPost.save(g),CoursePress.UnitsPost.off("coursepress:get_student_modules_success"),CoursePress.UnitsPost.on("coursepress:get_student_modules_success",function(b){a("#user-"+b.student_id).after(f(b))}),d=a("#student-grade-"+c.student),e=!0}e=d.is(":visible"),d[e?"hide":"show"](),b[e?"removeClass":"addClass"]("active")},v=function(){var b=a("#base_location").val();b+="&course_id="+a(this).val(),window.location.assign(b)};CoursePress.Events.on("coursepress:assessment_loaded",function(){var b=a(".modules-answer-wrapper");b.length>0?(e(b.data("student")),a(".cp-edit-grade-box").attr("data-title",_coursepress.assessment_labels.help_tooltip)):n()}),a(document).ready(function(){CoursePress.Events.trigger("coursepress:assessment_loaded")}).on("change","#unit-list",n).on("change","#ungraded-list",n).on("click",".edit-no-feedback, .edit-with-feedback",f).on("click",".cp-submit-grade",g).on("change",".module-grade",i).on("click",".cp-cancel",j).on("click",".cp-edit-grade",u).on("click",".next-page, .last-page, .first-page, .prev-page",r).on("click",".modules-answer-wrapper .cp-toggle",t).on("click",".cp-save-as-draft",k).on("change","#grade-type",s).on("change","#course-list",v).on("submit",".assessment-search-student-box",o).on("click","#search_reset",p)}(jQuery);