/*! CoursePress - v2.2.2
 * https://premium.wpmudev.org/project/coursepress-pro/
 * Copyright (c) 2019; * Licensed GPLv2+ */
var CoursePress=CoursePress||{};CoursePress.Events=CoursePress.Events||_.extend({},Backbone.Events),function(a){function b(){a("#course-setup-steps").accordion({disabled:!0,autoHeight:!1,collapsible:!0,heightStyle:"content",active:0,animate:200}),_coursepress.course_title&&(a(".coursepress_settings_wrapper h1").append(": <small>"+_coursepress.course_title+"</small>"),a("#course_name").on("change",function(){a(".coursepress_settings_wrapper h1 small").html(a(this).val())})),a("#course-setup-steps .step-title").bind("click",function(){var b=jQuery(this),c=parseInt(b.attr("class").match(/step-\d{1,10}/g)[0].trim().split("-").pop()),d=1<c-1?c-1:1;if(!b.find(".status").hasClass("saved")&&!a(".step-title.step-"+d).find(".status").hasClass("saved"))return void b.effect("highlight",{color:"#ffabab",duration:300});a("#course-setup-steps").accordion("enable").accordion({active:c-1}).accordion("disable"),setTimeout(function(){var c=b.offset();a("body,html").animate({scrollTop:c.top-110,duration:200})},200)}),a(".chosen-select.medium").chosen({disable_search_threshold:5,width:"40%"}),a(".chosen-select.narrow").chosen({disable_search_threshold:5,width:"20%"});var b=a("table.course-structure-tree");if(a("tr",b)<100&&a("table.course-structure-tree").treegrid({initialState:"expanded"}),"function"==typeof a(document).datetimepicker){var c=a(".dateinput.timeinput").datetimepicker({dateFormat:"yy-mm-dd",timeFormat:"HH:mm",showButtonPanel:!1,timeInput:!0,controlType:"select",oneLine:!0,autoclose:!0,onSelect:function(){c.datepicker("hide")}});a(".dateinput").not(".dateinput.timeinput").datepicker({dateFormat:"yy-mm-dd",autoclose:!0})}a(".date").click(function(){a(this).parents("div").hasClass("disabled")||a(this).find(".dateinput").datepicker("show")}),a('[name="meta_enrollment_open_ended"]').change(function(){this.checked?(a(this).parents(".enrollment-dates").find(".start-date").addClass("disabled"),a(this).parents(".enrollment-dates").find(".start-date input").attr("disabled","disabled"),a(this).parents(".enrollment-dates").find(".end-date").addClass("disabled"),a(this).parents(".enrollment-dates").find(".end-date input").attr("disabled","disabled")):(a(this).parents(".enrollment-dates").find(".start-date").removeClass("disabled"),a(this).parents(".enrollment-dates").find(".start-date input").removeAttr("disabled"),a(this).parents(".enrollment-dates").find(".end-date").removeClass("disabled"),a(this).parents(".enrollment-dates").find(".end-date input").removeAttr("disabled"))}),a('[name="meta_course_open_ended"]').change(function(){this.checked?(a(this).parents(".course-dates").find(".end-date").addClass("disabled"),a(this).parents(".course-dates").find(".end-date input").attr("disabled","disabled")):(a(this).parents(".course-dates").find(".end-date").removeClass("disabled"),a(this).parents(".course-dates").find(".end-date input").removeAttr("disabled"))}),a(".spinners").spinner(),a('[name="meta_class_limited"]').change(function(){this.checked?(a(this).parents(".class-size").find(".num-students").removeClass("disabled"),a(this).parents(".class-size").find(".num-students input").removeAttr("disabled")):(a(this).parents(".class-size").find(".num-students").addClass("disabled"),a(this).parents(".class-size").find(".num-students input").attr("disabled","disabled"))}),a(".coursepress-ui-toggle-switch").coursepress_ui_toggle()}function c(){a("#course-setup-steps input").on("keyup change",function(){var b=a(this).parents(".cp-box-content")[0];a(b).find(".button.update.hidden").removeClass("hidden")}),a("#course-setup-steps select").on("change",function(){var b=a(this).parents(".cp-box-content")[0];a(b).find(".button.update.hidden").removeClass("hidden")}),CoursePress.Events.on("editor:keyup",function(b){var c=a(b.container).parents(".cp-box-content")[0];a(c).find(".button.update.hidden").removeClass("hidden")}),a(".cp-box-content .button.step.prev, .cp-box-content .button.step.next, .cp-box-content .button.step.update, .cp-box-content .button.step.finish").on("click",function(b){var c,d,e=jQuery(b.currentTarget);c=e.hasClass("step-1")?1:null,c=e.hasClass("step-2")?2:c,c=e.hasClass("step-3")?3:c,c=e.hasClass("step-4")?4:c,c=e.hasClass("step-5")?5:c,c=e.hasClass("step-6")?6:c,c=e.hasClass("step-7")?7:c;var f=[];if(1<=c&&f.push("course_name","course_excerpt"),2<=c&&f.push("course_description"),4<=c&&(f.push("meta_course_start_date"),a('[name="meta_course_open_ended"]').is(":checked")||f.push("meta_course_end_date"),a('[name="meta_enrollment_open_ended"]').is(":checked")||f.push("meta_enrollment_start_date","meta_enrollment_end_date")),7<=c&&(f.push("meta_minimum_grade_required","meta_pre_completion_title","meta_pre_completion_content"),f.push("meta_course_completion_title","meta_course_completion_content","meta_course_failed_title","meta_course_failed_content")),f.length>0){var g,h=0;if(g=function(b,c){var d=tinyMCE&&tinyMCE.get(b)?tinyMCE.get(b).getContent():c.val();return""==d&&(d=a("#"+b).val()),d},_.each(f,function(b){var c=a('[name="'+b+'"]'),d=c.val();c.removeClass("error"),"course_excerpt"==b&&(d=g("courseExcerpt",c)),"course_description"==b&&(d=g("courseDescription",c)),"meta_pre_completion_content"==b&&(d=g("pre-completion-content",c)),"meta_course_completion_content"==b&&(d=g("course-completion-editor-content",c)),"meta_course_failed_content"==b&&(d=g("course-failed-content",c)),d&&""!=d||(c.addClass("error"),h+=1)}),h>0)return CoursePress.Course.hasError=!0,alert(_coursepress.labels.required_fields),!1;CoursePress.Course.hasError=!1}d=e.hasClass("prev")?"prev":null,d=e.hasClass("next")?"next":d,d=e.hasClass("update")?"update":d,d=e.hasClass("finish")?"finish":d,null!==c&&(CoursePress.Course.show_message(_coursepress.unit_builder_form.messages.setup.saving,"info"),a(".step-title.step-"+c).find(".status").removeClass("saved"),a(".step-title.step-"+c).find(".status").removeClass("save-error"),a(".step-title.step-"+c).find(".status").removeClass("save-attention"),a(".step-title.step-"+c).find(".status").addClass("save-process"),CoursePress.Course.get_step(c,d),CoursePress.Course.save())}),a(".button.browse-media-field").browse_media_field(),a.fn.wpColorPicker&&a(".certificate-color-picker").wpColorPicker(),a('.cp-box-content .course-structure input[type="checkbox"]').on("change",function(b){var c=a(b.currentTarget),d=c.attr("name"),e=null!=d.match(/visible/)?"visible":"preview",f="meta_structure_"+e,g=a(".course-structure-tree"),h=c.is(":checked"),i=c.parents("tr").first(),j=i.attr("data-unitid"),k=function(b){g.find('tr[data-unitid="'+j+'"]').find('[name*="'+f+'_pages"]').each(function(){var c=a(this);c.is(":checked"),m=c.parents("tr[data-pagenumber]").first().attr("data-pagenumber"),b?c.attr("checked",!0):c.attr("checked",!1),l(b,m)})},l=function(b,c){g.find('tr[data-unitid="'+j+'"][data-pagenumber="'+c+'"]').find('[name*="'+f+'_modules"]').each(function(){var c=a(this);c.is(":checked"),b?c.attr("checked",!0):c.attr("checked",!1)})};if(d.match(/_units/))k(h);else if(d.match(/_pages/)){var m=c.parents("tr").first().attr("data-pagenumber"),n=g.find(".unit-"+j).find('[name*="'+f+'_unit"]'),o=g.find('.page[data-unitid="'+j+'"]').find('[name*="'+f+'_pages"]:checked');n.attr("checked",o.length>0),l(h,m)}else{var m=i.attr("data-pagenumber"),n=g.find(".unit-"+j).find('[name*="'+f+'_unit"]'),p=g.find(".page-"+m+'[data-unitid="'+j+'"]').find('[name*="'+f+'_page"]'),q=g.find('tr[data-unitid="'+j+'"][data-pagenumber="'+m+'"]').find('[name*="'+f+'_modules"]:checked');p.attr("checked",q.length>0);var o=g.find('.page[data-unitid="'+j+'"]').find('[name*="'+f+'_pages"]:checked');n.attr("checked",o.length>0)}}),a(".button.instructor-assign").on("click",function(){if(a(this).hasClass("disabled"))return!1;var b=a('select[name="instructors"]'),c=parseInt(b.val()),d=b.html(),e=a("#instructor_holder_"+c).length>0,g=a(".select2-selection__rendered"),h=a("#instructors-info");if(!e){g.html(_coursepress.labels.user_dropdown_placeholder);a('<div class="instructor-avatar-holder empty" id="instructor_holder_'+c+'"><span class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></span></div>').appendTo(h);CoursePress.Course.set("action","add_instructor");var i={instructor_id:c,course_id:_coursepress.course_id,instructor_name:d,nonce:f()};CoursePress.Course.set("data",i),CoursePress.Course.save()}}),d(".avatar-holder .remove a"),a(".instructor-invite input").keypress(function(b){if(13===b.which){switch(a(this).attr("name")){case"invite_instructor_first_name":a("[name=invite_instructor_last_name]").trigger("focus");break;case"invite_instructor_last_name":a("[name=invite_instructor_email]").trigger("focus");break;case"invite_instructor_email":case"invite_instructor_trigger":a("#invite-instructor-trigger").trigger("click"),a("[name=invite_instructor_first_name]").trigger("focus")}b.preventDefault()}}),a("#invite-instructor-trigger").on("click",function(){var b=a("[name=invite_instructor_email]").val(),c=a("[name=invite_instructor_first_name]").val(),d=a("[name=invite_instructor_last_name]").val(),e=a("[name=invite_instructor_type]:checked").val();if(null!==b.match(_coursepress.email_validation_pattern)){CoursePress.Course.set("action","invite_instructor");var g={first_name:c,last_name:d,who:e,email:b,course_id:_coursepress.course_id,nonce:f()};CoursePress.Course.set("data",g),CoursePress.Course.on("coursepress:invite_instructor_success",function(){a('[name="invite_instructor_first_name"],[name="invite_instructor_last_name"],[name="invite_instructor_email"]').val("")}),CoursePress.Course.save()}}),a('[name="meta_enrollment_type"]').on("change",function(){var b=a(this).val();a(".cp-box-content.step-6 .enrollment-type-options").addClass("hidden"),a(".step-content.step-6 .enrollment-type-options."+b).removeClass("hidden")}),a('[name="meta_payment_paid_course"]').on("change",function(){this.checked?(a(this).parents(".cp-box-content.step-6").find(".payment-message").removeClass("hidden"),a(this).parents(".cp-box-content.step-6").find(".is_paid_toggle").removeClass("hidden")):(a(this).parents(".cp-box-content.step-6").find(".payment-message").addClass("hidden"),a(this).parents(".cp-box-content.step-6").find(".is_paid_toggle").addClass("hidden"))}),a('[name="publish-course-toggle"]').on("change",function(b,c){var d=a(this).attr("data-nonce"),e="off"===c?"draft":"publish";CoursePress.Course.set("action","toggle_course_status");var f={nonce:d,status:e,state:c,course_id:_coursepress.course_id};CoursePress.Course.set("data",f),CoursePress.Course.save()}),a(".add-new-student-button").on("click",function(b){b.stopImmediatePropagation(),b.preventDefault();var c=a(this).attr("data-nonce");CoursePress.Course.set("action","enroll_student");var d={nonce:c,course_id:_coursepress.course_id,student_id:a("#student-add").val()};CoursePress.Course.set("data",d),CoursePress.Course.save()}),a("a.withdraw-student").on("click",function(){if(window.confirm(_coursepress.student_delete_confirm)){CoursePress.Course.set("action","withdraw_student");var b={student_id:a(this).attr("data-id"),course_id:_coursepress.course_id,nonce:a(this).attr("data-nonce")};return CoursePress.Course.set("data",b),CoursePress.Course.save(),CoursePress.Course.on("coursepress:withdraw_student_success",function(){window.location.reload()}),!1}}),a("a.withdraw-all-students").on("click",function(){if(window.confirm(_coursepress.student_delete_all_confirm)){CoursePress.Course.set("action","withdraw_all_students");var b={course_id:_coursepress.course_id,nonce:a(this).attr("data-nonce")};return CoursePress.Course.set("data",b),CoursePress.Course.save(),CoursePress.Course.on("coursepress:withdraw_all_students_success",function(){window.location.reload()}),!1}}),a(".coursepress_course_invite_student_wrapper input").keypress(function(b){if(13===b.which){switch(a(this).attr("name")){case"invite-firstname":a("[name=invite-lastname]").trigger("focus");break;case"invite-lastname":a("[name=invite-email]").trigger("focus");break;case"invite-email":case".coursepress_course_invite_student_wrapper .invite-submit":a(".coursepress_course_invite_student_wrapper .invite-submit").trigger("click"),a("[name=invite-firstname]").trigger("focus")}b.preventDefault()}}),a(".coursepress_course_invite_student_wrapper .invite-submit").on("click",function(){var b=a("[name=invite-email]").val(),c=a("[name=invite-firstname]").val(),d=a("[name=invite-lastname]").val();if(null!==b.match(_coursepress.email_validation_pattern)){a(".coursepress_course_invite_student_wrapper .invite-submit").prepend('<i class="fa fa-spinner fa-spin invite-progress"></i> '),CoursePress.Course.set("action","invite_student");var e={first_name:c,last_name:d,email:b,course_id:_coursepress.course_id,nonce:a(this).attr("data-nonce")};CoursePress.Course.set("data",e),CoursePress.Course.save(),CoursePress.Course.on("coursepress:invite_student_success",function(){window.location.reload()})}a("[name=invite-email]").val(""),a("[name=invite-firstname]").val(""),a("[name=invite-lastname]").val("")}),a(".column-actions .resend-invite").on("click",function(){var b=a(this),c=b.data();return a("[name=invite-email]").val(c.email),a("[name=invite-firstname]").val(c.firstname),a("[name=invite-lastname]").val(c.lastname),a(".coursepress_course_invite_student_wrapper .invite-submit").trigger("click"),!1}),a(".column-actions .remove-invite").on("click",function(){var b=this,c=a(this).data(),d={email:c.email,nonce:c.nonce,course_id:_coursepress.course_id};return CoursePress.Course.set("action","remove_student_invitation"),CoursePress.Course.set("data",d),CoursePress.Course.save(),CoursePress.Course.on("coursepress:remove_student_invitation_success",function(){a(b).parents("tr").first().slideUp(function(){a(this).remove(),a(".invited-list").length||a(".invited-students").hide()})}),!1}),a(".button.facilitator-assign").on("click",function(){if(a(this).hasClass("disabled"))return!1;var b=a('[name="facilitators"]'),c=b.val(),d=b.find(":selected").text(),e=(_coursepress.instructor_avatars.default,a(".facilitator-info")),g=a("#facilitator-"+c).length>0,h=a(".select2-selection__rendered");if(!g){h.html(_coursepress.labels.user_dropdown_placeholder);var i={facilitator_id:c,facilitator_name:d,course_id:_coursepress.course_id,nonce:f()};a('<div class="facilitator-avatar-holder empty" id="facilitator-'+c+'"><span class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></span></div>').appendTo(e);CoursePress.Course.set("action","add_facilitator"),CoursePress.Course.set("data",i),CoursePress.Course.save()}}),CoursePress.remove_facilitator=function(){var b=a(this).parent(),c=b.data("id");b.hide();var d={facilitator_id:c,nonce:f(),course_id:_coursepress.course_id};CoursePress.Course.set("action","remove_facilitator"),CoursePress.Course.set("data",d),CoursePress.Course.save()},a(".facilitator-remove").on("click",CoursePress.remove_facilitator),a(".coursepress_course_email_enroled_students_wrapper .send-submit").on("click",function(){var b=a('[name="send_to"]').val(),c=a("[name=email-subject]").val(),d=a("[name=email-body]").val(),e=a("#send-email-to-enroled-students");a(".coursepress_course_email_enroled_students_wrapper .send-submit").hide(),a(".coursepress-email-field",e).slideUp(),a(".coursepress-email-sending",e).slideDown(),CoursePress.Course.set("action","send_email");var f={send_to:b,subject:c,body:d,course_id:_coursepress.course_id,nonce:a(this).attr("data-nonce")};CoursePress.Course.set("data",f),CoursePress.Course.save(),CoursePress.Course.off("coursepress:send_email_success"),CoursePress.Course.on("coursepress:send_email_success",function(b){a(".coursepress-email-sending td",e).html(b.message.info),a(".coursepress-email-field-subject td",e).html(b.message.subject),a(".coursepress-email-field-body td",e).html(b.message.body),a(".coursepress-email-field",e).slideDown()}),CoursePress.Course.off("coursepress:send_email_error"),CoursePress.Course.on("coursepress:send_email_error",function(b){a(".coursepress-email-sending td",e).html(b.message.info),a(".coursepress-email-field-subject td",e).html(b.message.subject),a(".coursepress-email-field-body td",e).html(b.message.body),a(".coursepress-email-field",e).slideDown()})})}function d(b){a(b).on("click",function(b){var c,d,e,g=b.currentTarget,h=a(g).parents(".avatar-holder").data();switch(h.status){case"confirmed":e=_coursepress.instructor_delete_confirm,"facilitator"===h.who&&(e=_coursepress.facilitator_delete_confirm),window.confirm(e)&&(a(g).html('<span class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></span>'),a(g).parent().addClass("removing-process"),c=a(g).parents(".cp-box-content")[0],a(c).find(".button.update.hidden").removeClass("hidden"),CoursePress.Course.set("action","delete_instructor"),d={instructor_id:h.id,who:h.who,course_id:_coursepress.course_id,nonce:f()},CoursePress.Course.set("data",d),CoursePress.Course.save(),a("#student-add, #facilitators, #instructors").select2("val",""));break;case"pending":e=_coursepress.instructor_delete_invite_confirm,"facilitator"===h.who&&(e=_coursepress.facilitator_delete_invite_confirm),window.confirm(e)&&(a(g).html('<span class="fa fa-circle-o-notch fa-spin fa-2x fa-fw"></span>'),a(g).parent().addClass("removing-process"),c=a(g).parents(".cp-box-content")[0],a(c).find(".button.update.hidden").removeClass("hidden"),CoursePress.Course.set("action","delete_instructor_invite"),d={invite_code:h.code,who:h.who,course_id:_coursepress.course_id,nonce:f()},CoursePress.Course.set("data",d),CoursePress.Course.save())}})}function e(b){b.nonce&&a("#course-setup-steps").attr("data-nonce",b.nonce)}function f(){return a("#course-setup-steps").attr("data-nonce")}function g(){CoursePress.Course.on("coursepress:update_course_success",function(b){b.last_step==b.next_step&&CoursePress.Course.show_message(_coursepress.unit_builder_form.messages.setup.saved,"success"),a(".step-title.step-"+b.last_step).find(".status").addClass("saved"),a(".step-title.step-"+b.last_step).find(".status").removeClass("save-error"),a(".step-title.step-"+b.last_step).find(".status").removeClass("save-attention"),a(".step-title.step-"+b.last_step).find(".status").removeClass("save-process"),b.next_step!==b.last_step&&a(".step-title.step-"+b.next_step).click();var c=a(".step-content.step-"+b.last_step).find(".course-step-buttons")[0];if(a("#step-done-message").remove(),a(c).append('<span id="step-done-message">&nbsp;<i class="fa fa-check"></i></span>'),a("#step-done-message").show(function(){a(this).fadeOut(1e3)}),a(c).find(".update").addClass("hidden"),a('[name="course_id"]').val(b.course_id),_coursepress.course_id=b.course_id,e(b),b.redirect){var d=location.href.replace("&tab=setup","");/\&post/.test(d)||(d+="&post="+b.course_id),/\&action=edit/.test(d)||(d+="&action=edit"),/post-new.php/.test(d)&&(d=d.replace(/post-new.php/,"post.php")),location.href=d+"&tab=units"}else{var f=a("#edit_course_link_url");f.length>0&&window.history.pushState&&window.history.pushState({},null,f.val())}}),CoursePress.Course.on("coursepress:update_course_error",function(b){CoursePress.Course.show_message(_coursepress.unit_builder_form.messages.setup.error,"error"),a(".step-title.step-"+b.last_step).find(".status").removeClass("saved"),a(".step-title.step-"+b.last_step).find(".status").addClass("save-error"),a(".step-title.step-"+b.last_step).find(".status").removeClass("save-attention"),a(".step-title.step-"+b.last_step).find(".status").removeClass("save-process")}),CoursePress.Course.on("coursepress:add_instructor_success",function(b){var c="",f=(_coursepress.instructor_avatars.default,wp.template("course-person"));a("input.button.instructor-assign").addClass("disabled"),b.avatar&&b.avatar,a("#"+b.who+"_holder_"+b.id).remove(),c+=f(b),"instructor"==b.who&&a(".instructor-avatar-holder.empty").length>0&&a(".instructor-avatar-holder.empty").detach(),0===a("#"+b.who+"_holder_"+b.id).length&&(a("#"+b.who+"s-info").append(c),d("#"+b.who+"_holder_"+b.id+" .remove a")),e(b)}),CoursePress.Course.on("coursepress:delete_instructor_success",function(b){if(a("#"+b.who+"_holder_"+b.instructor_id).detach(),"instructor"==b.who){var c='<div class="instructor-avatar-holder empty"><span class="instructor-name">'+_coursepress.instructor_empty_message+"</span></div>";0===a(".instructor-avatar-holder").length&&a("#instructors-info").append(c)}e(b)}),CoursePress.Course.on("coursepress:invite_instructor_success",function(b){var c=wp.template("course-invitation"),f=b.data.email,g=b.invite_code,h=(CoursePress.utility.get_gravatar_image(f,80),""),i="",j="instructor",k=b.data;void 0!==b.data.who&&(j=b.data.who),k.who=j,k.code=g,k.avatar=b.avatar,h+=c(k),"instructor"==j&&a(".instructor-avatar-holder.empty",parent).length>0&&a(".instructor-avatar-holder.empty",parent).detach(),0===a("#"+j+"_holder_"+g).length?(a("#"+j+"s-info").append(h),d("#"+j+"_holder_"+g+" .remove a"),i=' <span class="message"><span class="dashicons dashicons-yes"></span> '+b.message.sent+"</span>"):i=' <span class="message"><span class="dashicons dashicons-yes"></span> '+b.message.exists+"</span>",a(".instructor-invite .submit-message").append(i),a(".instructor-invite .submit-message .message").fadeOut(3e3),e(b)}),CoursePress.Course.on("coursepress:invite_instructor_error",function(b){var c=' <span class="message"><span class="dashicons dashicons-yes"></span> '+b.message.send_error+"</span>";a(".instructor-invite .submit-message").append(c),a(".instructor-invite .submit-message .message").fadeOut(3e3),e(b)}),CoursePress.Course.on("coursepress:delete_instructor_invite_success",function(b){var c="instructor";void 0!==b.who&&(c=b.who),a("#"+c+"_holder_"+b.invite_code).detach(),e(b)}),CoursePress.Course.on("coursepress:add_facilitator_success",function(b){var c=wp.template("course-person");b.facilitator_id,_coursepress.instructor_avatars.default;a("input.button.facilitator-assign").addClass("disabled"),b.avatar&&b.avatar,content=c(b),0===a("#"+b.who+"_holder_"+b.id).length&&(a("#"+b.who+"-"+b.id).detach(),a("#"+b.who+"s-info").append(content),d("#"+b.who+"_holder_"+b.id+" .remove a")),e(b)}),CoursePress.Course.on("coursepress:add_facilitator_error",function(b){var c=a("#facilitator-"+b.facilitator_id).empty();c.html(b.message),c.fadeOut(3e3,function(){c.remove()}),e(b)}),CoursePress.Course.on("coursepress:remove_facilitator_success",function(b){a("#facilitator-"+b.facilitator_id).remove(),e(b)}),CoursePress.Course.on("coursepress:toggle_course_status_success",function(b){a('[name="publish-course-toggle"]').attr("data-nonce",b.nonce)}),CoursePress.Course.on("coursepress:toggle_course_status_error",function(){var b=a('[name="publish-course-toggle"]');a(b).hasClass("on")?a(b).removeClass("on").addClass("off"):a(b).hasClass("off")&&a(b).removeClass("off").addClass("on")}),CoursePress.Course.on("coursepress:enroll_student_success",function(){location.reload()}),CoursePress.Course.on("coursepress:withdraw_student_success",function(){location.reload()}),CoursePress.Course.on("coursepress:withdraw_all_students_success",function(){location.reload()}),CoursePress.Course.on("coursepress:invite_student_success",function(b){a(".invite-progress").detach(),a(".coursepress_course_invite_student_wrapper .invite-submit").attr("data-nonce",b.nonce)}),CoursePress.Course.on("coursepress:invite_student_error",function(){a(".invite-progress").detach()})}function h(){function b(){var b=a(c).is(":checked"),e=a(d).is(":checked");a("tbody tr").css("display","none");var f="";e?(a("tr.treegrid-expanded ~ tr.submitted").css("display","table-row"),a("tr.treegrid-expanded ~ tr.not-submitted").css("display","none"),f=".submitted"):(a("tr.treegrid-expanded ~ tr.submitted").css("display","table-row"),a("tr.treegrid-expanded ~ tr.not-submitted").css("display","table-row")),b?(a("tr.treegrid-expanded ~ tr.ungraded"+f).css("display","table-row"),a("tr.treegrid-expanded ~ tr.graded"+f).css("display","none")):(a("tr.treegrid-expanded ~ tr.ungraded"+f).css("display","table-row"),a("tr.treegrid-expanded ~ tr.graded"+f).css("display","table-row")),a("tbody tr.student-name").css("display","table-row")}var c='.coursepress_settings_wrapper.assessment .ungraded-elements [type="checkbox"]',d='.coursepress_settings_wrapper.assessment .submitted-elements [type="checkbox"]';a(c).on("click",function(){b(this)}),a(d).on("click",function(){b(this)}),a(".coursepress_settings_wrapper.assessment table").treegrid().on("expand",function(){b(this)}),a(".coursepress_settings_wrapper.assessment table .instructor-feedback").link_popup({link_text:'<span class="dashicons dashicons-admin-comments"></span>'}),a('.coursepress_settings_wrapper.assessment [name="course-list"]').on("change",function(){var b=a(this).val();location.href=_coursepress.assessment_grid_url+"&course_id="+b}),a(".coursepress_settings_wrapper.assessment .collapse-all-students").on("click",function(){a(".coursepress_settings_wrapper.assessment table").treegrid("collapseAll")}),a(".coursepress_settings_wrapper.assessment .expand-all-students").on("click",function(){a(".coursepress_settings_wrapper.assessment table").treegrid("expandAll")})}function i(){a(".coursepress_settings_wrapper.reports .help-tooltip").link_popup({link_text:'<span class="dashicons dashicons-editor-help"></span>',offset_x:20}),a('.coursepress_settings_wrapper.reports [name="course-list"]').on("change",function(){var b=a(this).val();location.href=_coursepress.assessment_report_url+"&course_id="+b}),a(".coursepress_settings_wrapper.reports .column-report .pdf").on("click",function(){if(!1===a(this).data("click"))return!1;var b=a(this).parents("form")[0],c=a(this).attr("data-student");a(b).find("[name=students]").val(c),b.submit()})}function j(){a('[name*="publish-notification-toggle"]').on("change",function(b,c){CoursePress.Post.prepare("update_notification","notification:"),CoursePress.Post.set("action","toggle");var d=a(this).attr("data-nonce"),e="off"===c?"draft":"publish",f=parseInt(a(this).attr("id").replace("publish-notification-toggle-","")),g={nonce:d,status:e,state:c,notification_id:f};CoursePress.Post.set("data",g),CoursePress.Post.save()}),a(".delete-notification-link").on("click",function(b){if(b.stopImmediatePropagation(),b.preventDefault(),window.confirm(_coursepress.notification_delete)){CoursePress.Post.prepare("update_notification","notification:"),CoursePress.Post.set("action","delete");var c={nonce:a(this).attr("data-nonce"),notification_id:a(this).attr("data-id")};CoursePress.Post.set("data",c),CoursePress.Post.save()}}),CoursePress.Post.on("coursepress:notification:delete_success",function(){location.reload()}),CoursePress.Post.on("coursepress:notification:toggle_error",function(b){var c=a("#publish-notification-toggle-"+b.ID);c.hasClass("on")?c.removeClass("on").addClass("off"):c.removeClass("off").addClass("on")}),a('.coursepress_communications_wrapper.notifications [id*="doaction"]').on("click",function(){var b=a(this).siblings('[id*="bulk-action-selector"]').val();if("delete"===b&&!window.confirm(_coursepress.notification_bulk_delete))return!1;if(void 0!==b&&-1!==b){var c=[];a.each(a('[name*="bulk-actions"]'),function(b,d){a(d).is(":checked")&&c.push(a(d).val())}),CoursePress.Post.prepare("update_notification","notification:"),CoursePress.Post.set("action","bulk_"+b);var d={nonce:a(".nonce-holder").attr("data-nonce"),ids:c};CoursePress.Post.set("data",d),CoursePress.Post.save()}}),CoursePress.Post.on("coursepress:notification:bulk_publish_success",function(){location.reload()}),CoursePress.Post.on("coursepress:notification:bulk_unpublish_success",function(){location.reload()}),CoursePress.Post.on("coursepress:notification:bulk_delete_success",function(){location.reload()})}function k(){a('[name*="publish-discussion-toggle"]').on("change",function(b,c){CoursePress.Post.prepare("update_discussion","discussion:"),CoursePress.Post.set("action","toggle");var d=a(this).attr("data-nonce"),e="off"===c?"draft":"publish",f=parseInt(a(this).attr("id").replace("publish-discussion-toggle-","")),g={nonce:d,status:e,state:c,discussion_id:f};CoursePress.Post.set("data",g),CoursePress.Post.save()}),a(".delete-discussion-link").on("click",function(b){if(b.stopImmediatePropagation(),b.preventDefault(),window.confirm(_coursepress.discussion_delete)){CoursePress.Post.prepare("update_discussion","discussion:"),CoursePress.Post.set("action","delete");var c={nonce:a(this).attr("data-nonce"),discussion_id:a(this).attr("data-id")};CoursePress.Post.set("data",c),CoursePress.Post.save()}}),CoursePress.Post.on("coursepress:discussion:delete_success",function(){location.reload()}),CoursePress.Post.on("coursepress:discussion:toggle_error",function(b){var c=a("#publish-discussion-toggle-"+b.ID);c.hasClass("on")?c.removeClass("on").addClass("off"):c.removeClass("off").addClass("on")}),a('.coursepress_communications_wrapper.discussions [id*="doaction"]').on("click",function(){var b=a(this).siblings('[id*="bulk-action-selector"]').val();if("delete"===b&&!window.confirm(_coursepress.discussion_bulk_delete))return!1;if(void 0!==b&&-1!==b){var c=[];a.each(a('[name*="bulk-actions"]'),function(b,d){a(d).is(":checked")&&c.push(a(d).val())}),CoursePress.Post.prepare("update_discussion","discussion:"),CoursePress.Post.set("action","bulk_"+b);var d={nonce:a(".nonce-holder").attr("data-nonce"),ids:c};CoursePress.Post.set("data",d),CoursePress.Post.save()}}),CoursePress.Post.on("coursepress:discussion:bulk_publish_success",function(){location.reload()}),CoursePress.Post.on("coursepress:discussion:bulk_unpublish_success",function(){location.reload()}),CoursePress.Post.on("coursepress:discussion:bulk_delete_success",function(){location.reload()}),a(".coursepress_communications_wrapper.discussions select#course_id").on("change",function(){var b=a(this).val();a.each(a(".coursepress_communications_wrapper.discussions select#unit_id").find("option"),function(b,c){"course"!==a(c).val()&&a(c).detach()}),CoursePress.Post.prepare("update_discussion","discussion:"),CoursePress.Post.set("action","unit_items");var c={course_id:b};CoursePress.Post.set("data",c),CoursePress.Post.save()}),CoursePress.Post.on("coursepress:discussion:unit_items_success",function(b){b.items.length>0&&a.each(b.items,function(b,c){a(".coursepress_communications_wrapper.discussions select#unit_id").append('<option value="'+c.key+'">'+c.value+"</option>")})})}function l(a){return a.loading?a.text:'<div class="select2-result-course clearfix">'+a.gravatar+" <span>"+a.display_name+"</span></div>"}function m(a){return a&&(a.gravatar||a.display_name)?'<div class="select2-result-course clearfix">'+a.gravatar+" <span>"+a.display_name+"</span></div>":_coursepress.labels.user_dropdown_placeholder}CoursePress.Models=CoursePress.Models||{},CoursePress.Models.Course=CoursePress.Models.Course||Backbone.Model.extend({url:_coursepress._ajax_url+"?action=update_course",parse:function(a){!0===a.success?(this.set("response_data",a.data),this.trigger("coursepress:"+a.data.action+"_success",a.data)):(this.set("response_data",{}),this.trigger("coursepress:"+a.data.action+"_error",a.data)),CoursePress.Course.set("action","")},defaults:{}}),CoursePress.Course=new CoursePress.Models.Course,CoursePress.Models.Post=CoursePress.Models.Post||Backbone.Model.extend({url:_coursepress._ajax_url+"?action=",parse:function(a){var b=this.get("context");if(!0===a.success){void 0===a.data&&(a.data={}),this.set("response_data",a.data);var c="coursepress:"+b+a.data.action+"_success";this.trigger(c,a.data)}else 0!==a&&(this.set("response_data",{}),this.trigger("coursepress:"+b+a.data.action+"_error",a.data));CoursePress.Course.set("action","")},prepare:function(a,b){this.url=this.get("base_url")+a,void 0!==b&&this.set("context",b)},defaults:{base_url:_coursepress._ajax_url+"?action=",context:"response:"}}),CoursePress.Post=new CoursePress.Models.Post,CoursePress.Course.multiple_elements=function(b,c){var d=0;return a.each(b,function(a,b){c===b.name&&(d+=1)}),d>1},CoursePress.Course.add_array_to_data=function(b,c){var d=0,e="";a.each(c,function(a,f){var g=f.name.replace(/(\[|\]\[)/g,"/").replace(/\]/g,"");e!==g&&(d=0),g.match(/\/$/g)||CoursePress.Course.multiple_elements(c,f.name)?g.match(/\/$/g)?CoursePress.utility.update_object_by_path(b,g+d,f.value):CoursePress.utility.update_object_by_path(b,g+"/"+d,f.value):CoursePress.utility.update_object_by_path(b,g,f.value),d+=1,e=g})},CoursePress.Course.fix_step_checkboxes=function(a,b,c){return CoursePress.utility.fix_checkboxes(a,".step-content.step-"+b,c)},CoursePress.Course.hasError=!1,CoursePress.Course.get_step=function(b,c){void 0===c&&(c="next");var d,e={};if(e.step=b,e.is_finished=!1,1<=b&&(e.course_id=a('[name="course_id"]').val(),e.course_name=a('[name="course_name"]').val(),e.course_excerpt=tinyMCE&&tinyMCE.get("courseExcerpt")?tinyMCE.get("courseExcerpt").getContent():a('[name="course_excerpt"]').val(),d=a('.cp-box-content.step-1 [name^="meta_"]').serializeArray(),d=CoursePress.Course.fix_step_checkboxes(d,b),CoursePress.Course.add_array_to_data(e,d)),2<=b&&(e.course_description=tinyMCE&&tinyMCE.get("courseDescription")?tinyMCE.get("courseDescription").getContent():a('[name="course_description"]').val(),d=a('.cp-box-content.step-2 [name^="meta_"]').serializeArray(),d=CoursePress.Course.fix_step_checkboxes(d,b,"0"),CoursePress.Course.add_array_to_data(e,d)),3<=b&&(d=a('.cp-box-content.step-3 [name^="meta_"]').serializeArray(),d=CoursePress.Course.fix_step_checkboxes(d,b,"0"),CoursePress.Course.add_array_to_data(e,d)),4<=b&&(d=a('.cp-box-content.step-4 [name^="meta_"]').serializeArray(),d=CoursePress.Course.fix_step_checkboxes(d,b,"0"),CoursePress.Course.add_array_to_data(e,d)),5<=b&&(d=a('.cp-box-content.step-5 [name^="meta_"]').serializeArray(),d=CoursePress.Course.fix_step_checkboxes(d,b,"0"),CoursePress.Course.add_array_to_data(e,d)),6<=b&&(d=a('.cp-box-content.step-6 [name^="meta_"]').serializeArray(),d=CoursePress.Course.fix_step_checkboxes(d,b,"0"),CoursePress.Course.add_array_to_data(e,d)),7<=b){course_completion_content=tinyMCE&&tinyMCE.get("course-completion-editor-content")?tinyMCE.get("course-completion-editor-content").getContent():a('[name="meta_course_completion_content"]').val(),a('[name="meta_course_completion_content"]').val(course_completion_content),pre_completion_content=tinyMCE&&tinyMCE.get("pre-completion-content")?tinyMCE.get("pre-completion-content").getContent():a('[name="meta_pre_completion_content"]').val(),a('[name="meta_pre_completion_content"]').val(pre_completion_content),failed_content=tinyMCE&&tinyMCE.get("course-failed-content")?tinyMCE.get("course-failed-content").getContent():a('[name="meta_course_failed_content"]').val(),a('[name="meta_course_failed_content"]').val(failed_content),basic_certificate_layout=tinyMCE&&tinyMCE.get("basic-certificate-layout")?tinyMCE.get("basic-certificate-layout").getContent():a('[name="meta_basic_certificate_layout"]').val(),a('[name="meta_basic_certificate_layout"]').val(basic_certificate_layout),d=a('.cp-box-content.step-7 [name^="meta_"]').serializeArray();a('[name="meta_basic_certificate"]').is(":checked")||d.push({name:"meta_basic_certificate",value:!1}),d=CoursePress.Course.fix_step_checkboxes(d,b,"0"),CoursePress.Course.add_array_to_data(e,d)}var g=a("#course_categorychecklist input:checked"),h=[];0<g.length&&(g.each(function(){var b=a(this);h.push({name:"meta_course_category",value:b.val()})}),CoursePress.Course.add_array_to_data(e,h));var i=b;"next"===c&&(e.meta_setup_marker=b,i=7!==i?i+1:i),"prev"===c&&(e.meta_setup_marker=b-1,i=1!==i?i-1:i),"finish"===c&&(e.meta_setup_marker=b,e.is_finished=!0),e.post_status=a("#post_status").val(),e.nonce=f(),CoursePress.Course.set("data",e),CoursePress.Course.set("action","update_course"),CoursePress.Course.set("next_step",i)},CoursePress.Course.show_message=function(b,c){a(".cp-box-content .course-step-buttons .notice").detach(),a(".cp-box-content.ui-accordion-content-active .course-step-buttons").prepend('<div class="notice notice-'+c+'"><p>'+b+"</p></div>"),"success"===c&&setTimeout(function(){a(".cp-box-content .course-step-buttons .notice").fadeOut()},3e3)};var n=function(){var b=a(this),c=b.is(":checked"),d=a(".btn-cert"),e=a(this).closest(".wide.course-certificate");d[c?"addClass":"removeClass"]("button-primary"),c?a(".options, .btn-cert",e).slideDown():a(".options, .btn-cert",e).slideUp()},o=function(){var b=a(this),c=b.is(":checked"),d=a(this).closest(".wide");c?a(".column-time",d).show():a(".column-time",d).hide()},p={placeholder:_coursepress.labels.user_dropdown_placeholder,allowClear:!0,ajax:{url:_coursepress._ajax_url,dataType:"json",delay:250,data:function(b){return{q:b.term,page:b.page,action:"coursepress_user_search",course_id:_coursepress.course_id,_wpnonce:a(this).data("nonce-search")}},processResults:function(a,b){return b.page=b.page||1,{results:a.items,pagination:{more:30*b.page<a.total_count}}},cache:!0},escapeMarkup:function(a){return a},minimumInputLength:3,templateResult:l,templateSelection:m};CoursePress.updateCourse=function(){var b=a(this),c=a("#course-setup-steps .cp-box-content:visible .step.next");if(finishbutton=a("#course-setup-steps .cp-box-content:visible .finish.step-7"),0===c.length&&0===finishbutton.length){var d=(a('[name="s"]',b),a('[name="_wp_http_referer"]'));return b.attr("action",d.val()),!0}if(0===finishbutton.length)c.trigger("click");else{finishbutton.trigger("click");var e=b.serialize();CoursePress.Course.hasError||a.post(b.attr("action"),e)}return!1},CoursePress.maybeUpdateCourse=function(){var b=a("form#post"),c=a(this);if(0==b.length)return!0;if(c.is("#search-submit")){var d=b.find('[name="_wp_http_referer"]'),e=b.find('[name="s"]').val();return d=d.val()+"&s="+e,window.location=d,!1}if(c.is("#post-preview")){var f=c.attr("href");window.open(f)}return b.unbind("submit").submit(),!1},a(document).ready(function(){b(),c(),g(),h(),i(),j(),k(),jQuery("#course-setup-steps .step-title .status.setup_marker").click(),a('[name="meta_basic_certificate"]').each(n),"function"==typeof a().select2&&a("#student-add, #facilitators, #instructors").select2(p).on("select2:selecting",function(b){a("input.button.disabled",a(this).closest(".wide")).removeClass("disabled")}).on("select2:unselecting",function(b){a("input.button",a(this).closest(".wide")).addClass("disabled")}),a(".course-edit-notification .save-post-status, .course-edit-forums .save-post-status").click(function(b){a("#post-status-display").html(a("option:selected",a("#post-status-select")).text())}),a(".course-edit-notification input[type=submit], .course-edit-forums input[type=submit]").click(function(b){var c=a(".course-edit-notification").length>0,d=a(".course-edit-forums").length>0,e=[],f=!1;if(""===a("#titlewrap input[name=post_title]").val()&&(c?e.push(_coursepress.messages.notification.empty_title):d?e.push(_coursepress.messages.discussion.empty_title):e.push(_coursepress.messages.general.empty_title)),a(".wp-editor-wrap").hasClass("tmce-active")){var g=tinymce.activeEditor.getBody();0===tinymce.trim(g.innerText||g.textContent).length&&(f=!0)}else""===a(".wp-editor-wrap .wp-editor-area").val()&&(f=!0);return f&&(c?e.push(_coursepress.messages.notification.empty_content):d?e.push(_coursepress.messages.discussion.empty_content):e.push(_coursepress.messages.general.empty_content)),e.length?(alert(e.join("\n")),!1):(a(this).hasClass("button-primary")&&a(this).hasClass("force-publish")&&a("#post_status").val("publish"),!0)}),a("#course_id").change(function(b){"all"===a("option:selected",a(this)).val()?(a("#post-visibility-display").html(a("#misc-publishing-actions").data("no-options")),a("#visibility a.edit-visibility").hide()):(a("#post-visibility-display").html(a("input:checked",a("#visibility")).data("info")),a("#visibility a.edit-visibility").show())}),a(".course-edit-notification .save-post-visibility").click(function(b){a("#post-visibility-display").html(a("input:checked",a("#visibility")).data("info"))})}).on("click",".btn-cert",function(){var b=a(this);if(!b.is(".button-primary"))return!1;tinymce.triggerSave();var c=a("input, textarea",a(".course-certificate")).serialize(),d=[b.attr("href"),c];return window.open(d.join("&"),"_blank"),!1}).on("change",'[name="meta_basic_certificate"]',n).on("change",'[name="meta_structure_show_duration"]',o).on("click",".post-type-course #publish, .post-type-course #search-submit, .post-type-course #post-preview",CoursePress.maybeUpdateCourse).on("submit",".post-type-course form#post",CoursePress.updateCourse)}(jQuery);