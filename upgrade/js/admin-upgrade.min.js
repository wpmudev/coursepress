/*!  - v2.0.4
 * https://premium.wpmudev.org/project/coursepress-pro/
 * Copyright (c) 2017; * Licensed GPLv2+ */
_.extend(_coursepress_upgrade,{totalCourses:0,totalSuccess:0,totalSend:0,events:Backbone.Events,upgrade:Backbone.Model.extend({url:_coursepress_upgrade.ajax_url+"?action=coursepress_upgrade_update",initialize:function(a){_.extend(this,a),this.on("error",this.server_error,this);var b={_wpnonce:_coursepress_upgrade._wpnonce,course_id:this.course_id,user_id:this.user_id,container:!1,total_courses:_coursepress_upgrade.totalCourses,total_success:_coursepress_upgrade.totalSuccess};this.set(b),this.save()},parse:function(a){var b=this.container.$el.find(".course-progress");a&&(a.success?b.hasClass("error")||(b.addClass("success"),_coursepress_upgrade.totalSuccess+=1):b.hasClass("success")||(b.addClass("error"),_coursepress_upgrade.totalError+=1)),_coursepress_upgrade.totalSend+=1,_coursepress_upgrade.events.trigger("coursepress_update_done",this)},server_error:function(){window.alert(_coursepress_upgrade.server_error)}}),view:Backbone.View.extend({className:"coursepress-update-view",input:!1,template:'<span class="course-title"></span> <span class="course-progress"></span>',initialize:function(a){_.extend(this,a),this.render()},render:function(){if(this.input){var a,b;b=this.input.val(),this.input.parents().find("#cp-updated-"+b).remove(),a=this.input.data("name"),this.$el.append(this.template),this.$el.attr("id","cp-updated-"+b),this.$el.find(".course-title").html(a),this.$el.insertAfter(this.input),""!==this.input.data("done")?(_coursepress_upgrade.totalSuccess+=1,_coursepress_upgrade.totalSend+=1,this.$el.find(".course-progress").addClass("success"),_coursepress_upgrade.events.trigger("coursepress_update_done",this)):this.sync=new _coursepress_upgrade.upgrade({course_id:this.input.val(),type:this.input.data("type"),container:this,user_id:this.user_id})}}})}),function(a){var b=function(){var b,c,d,e,f,g=a(this),h=a('[name="course"]',g),i=a(".coursepress-upgrade-nag p"),j=a('[name="user_id"]',g).val(),k=g.find('[type="submit"]');return!k.is(":disabled")&&(0===i.length&&(c=a(".coursepress-upgrade-view h2"),i=a('<div class="notice notice-warning is-dismissible coursepress-upgrade-nag">').insertAfter(c),i=a("<p>").appendTo(i)),k.attr("disabled","disabled"),i.parent().removeClass("notice-error").addClass("notice-warning"),i.html(_coursepress_upgrade.noloading),_coursepress_upgrade.totalCourses=h.length,_coursepress_upgrade.totalSend=0,_coursepress_upgrade.totalSuccess=0,b=function(){_coursepress_upgrade.totalCourses===_coursepress_upgrade.totalSend&&(_coursepress_upgrade.totalCourses===_coursepress_upgrade.totalSuccess?(i.parent().removeClass("notice-warning"),i.html(_coursepress_upgrade.success),e=5,d=setInterval(function(){e-=1,i.find(".coursepress-counter").html(e),0===e&&(clearInterval(d),window.location=_coursepress_upgrade.cp2_url)},1e3)):(i.parent().removeClass("notice-warning").addClass("notice-error"),i.html(_coursepress_upgrade.failed)))},_coursepress_upgrade.events.off("coursepress_update_done"),_coursepress_upgrade.events.on("coursepress_update_done",b),h.each(function(){var b=a(this);f=new _coursepress_upgrade.view({input:b,user_id:j})}),!1)};a(document).on("submit","#coursepress-update-form",b)}(jQuery);